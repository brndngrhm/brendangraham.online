---
title: "Comparing Traditional and Text-Based Models to Predict Chocolate Rating"
author: Brendan Graham
date: '2022-01-18'
slug: chocolate-ratings
categories: 
  - tidy tuesday
  - tidymodels
  - data science
tags:
  - tidy tuesday
  - tidymodels
  - data science
subtitle: 
summary: 'This post looks at a [TidyTuesday](https://github.com/rfordatascience/tidytuesday) data set about chocolate. After looking at the data I compare text based and "traditional" modelling approaches to predict a chocolate ratings'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
draft: false
editor_options: 
  chunk_output_type: console
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<p>The goal for this weeks analysis to compare 2 types of models for predicting chocolate ratings. I have read bout text based models but haven’t every attempted one, so in this analysis I will compare some text-based models with more traditional ML models.</p>
<p>The data is composed of 2,530 observations of 10 variables. There is some missing ingredients data, but all other columns are complete.</p>
<pre class="r"><code>chocolate</code></pre>
<pre><code>## # A tibble: 2,530 × 10
##      ref company_manufacturer company_location review_date country_of_bean_orig…
##    &lt;dbl&gt; &lt;chr&gt;                &lt;chr&gt;                  &lt;dbl&gt; &lt;chr&gt;                
##  1  2454 5150                 U.S.A.                  2019 Tanzania             
##  2  2458 5150                 U.S.A.                  2019 Dominican Republic   
##  3  2454 5150                 U.S.A.                  2019 Madagascar           
##  4  2542 5150                 U.S.A.                  2021 Fiji                 
##  5  2546 5150                 U.S.A.                  2021 Venezuela            
##  6  2546 5150                 U.S.A.                  2021 Uganda               
##  7  2542 5150                 U.S.A.                  2021 India                
##  8   797 A. Morin             France                  2012 Bolivia              
##  9   797 A. Morin             France                  2012 Peru                 
## 10  1011 A. Morin             France                  2013 Panama               
## # … with 2,520 more rows, and 5 more variables:
## #   specific_bean_origin_or_bar_name &lt;chr&gt;, cocoa_percent &lt;chr&gt;,
## #   ingredients &lt;chr&gt;, most_memorable_characteristics &lt;chr&gt;, rating &lt;dbl&gt;</code></pre>
<pre class="r"><code>skimr::skim_to_list(chocolate)</code></pre>
<p><strong>Variable type: character</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">min</th>
<th align="right">max</th>
<th align="right">empty</th>
<th align="right">n_unique</th>
<th align="right">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">company_manufacturer</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">2</td>
<td align="right">39</td>
<td align="right">0</td>
<td align="right">580</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">company_location</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">4</td>
<td align="right">21</td>
<td align="right">0</td>
<td align="right">67</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">country_of_bean_origin</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">4</td>
<td align="right">21</td>
<td align="right">0</td>
<td align="right">62</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">specific_bean_origin_or_bar_name</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">3</td>
<td align="right">51</td>
<td align="right">0</td>
<td align="right">1605</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">cocoa_percent</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">3</td>
<td align="right">6</td>
<td align="right">0</td>
<td align="right">46</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">ingredients</td>
<td align="right">87</td>
<td align="right">0.97</td>
<td align="right">4</td>
<td align="right">14</td>
<td align="right">0</td>
<td align="right">21</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">most_memorable_characteristics</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">3</td>
<td align="right">37</td>
<td align="right">0</td>
<td align="right">2487</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">ref</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1429.80</td>
<td align="right">757.65</td>
<td align="right">5</td>
<td align="right">802</td>
<td align="right">1454.00</td>
<td align="right">2079.0</td>
<td align="right">2712</td>
<td align="left">▆▇▇▇▇</td>
</tr>
<tr class="even">
<td align="left">review_date</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">2014.37</td>
<td align="right">3.97</td>
<td align="right">2006</td>
<td align="right">2012</td>
<td align="right">2015.00</td>
<td align="right">2018.0</td>
<td align="right">2021</td>
<td align="left">▃▅▇▆▅</td>
</tr>
<tr class="odd">
<td align="left">rating</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">3.20</td>
<td align="right">0.45</td>
<td align="right">1</td>
<td align="right">3</td>
<td align="right">3.25</td>
<td align="right">3.5</td>
<td align="right">4</td>
<td align="left">▁▁▅▇▇</td>
</tr>
</tbody>
</table>
<div id="explore-the-data" class="section level2">
<h2>Explore the Data</h2>
<p>The average rating is around 3.3 or 3.4 out of 5, are ratings are slightly skewed to the left.</p>
<pre class="r"><code>chocolate %&gt;%
  ggplot(., aes(x = rating)) + 
  geom_histogram(bins = 10, alpha = .75, fill = bg_green) +
  bg_theme()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-1.png" width="864" /></p>
<p>There isn’t much of a relationship between cocoa percent and rating.</p>
<pre class="r"><code>chocolate %&gt;%
  mutate(cocoa_percent = as.numeric(str_remove_all(cocoa_percent, &quot;%&quot;))) %&gt;%
  ggplot(., aes(x = cocoa_percent, y = rating)) +
  geom_point(color = bg_blue) +
  bg_theme()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="864" /></p>
<p>chocolate with 2 and 3 ingredients seem to be rated higher than those with 4 or 5.</p>
<pre class="r"><code>chocolate %&gt;%
  mutate(ingredients = substr(ingredients, 1, 1)) %&gt;%
  ggplot(., aes(x = ingredients, y = rating, fill = ingredients)) + 
  geom_jitter(alpha = .50, show.legend = FALSE) + 
  geom_boxplot(show.legend = FALSE, alpha = .80) +
  bg_theme()  + 
  coord_flip() +
  scale_fill_npg()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="864" /></p>
</div>
<div id="model" class="section level2">
<h2>Model</h2>
<p>The <code>most memorable characteristics</code> column will be used along with number of ingredients as predictors of rating. The <code>most memorable characteristics</code> is split and pivoted into indicator variables. A 2nd recipe that includes <code>step_nzv()</code> will also be used to see if removing sparse ingredients improves model performance.</p>
<pre class="r"><code>max_characteristics &lt;- 
  chocolate %&gt;% 
  mutate(num_char = str_count(most_memorable_characteristics, &quot;,&quot;) + 1) %&gt;% 
  filter(num_char == max(num_char)) %&gt;%
  select(num_char) %&gt;%
  distinct() %&gt;% 
  pull(num_char)

choc_characteristics &lt;- 
  chocolate %&gt;% 
  mutate(ingredients = substr(ingredients, 1, 1)) %&gt;%
  tidyr::separate(most_memorable_characteristics, paste0(&quot;characteristic&quot;, 1:max_characteristics), sep = &quot;,&quot;) %&gt;% 
  pivot_longer(cols = starts_with(&quot;characteristic&quot;), values_to = &quot;characteristic&quot;) %&gt;%
  mutate(characteristic = trimws(characteristic)) %&gt;%
  select(-name) %&gt;%
  filter(!(is.na(characteristic)),
         characteristic != &#39;&#39;) %&gt;%
  mutate(characteristic_ind = 1) %&gt;%
  pivot_wider(names_from = characteristic, values_from = characteristic_ind) %&gt;%
  select(rating, ingredient_count = ingredients, `rich cocoa`:ncol(.)) %&gt;%
  filter(!(is.na(ingredient_count)))

choc_characteristics[is.na(choc_characteristics)] &lt;- 0

head(choc_characteristics)</code></pre>
<pre><code>## # A tibble: 6 × 973
##   rating ingredient_count `rich cocoa` fatty bready cocoa vegetal savory
##    &lt;dbl&gt; &lt;chr&gt;                   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
## 1   3.25 3                           1     1      1     0       0      0
## 2   3.5  3                           0     0      0     1       1      1
## 3   3.75 3                           0     0      0     1       0      0
## 4   3    3                           0     0      0     0       0      0
## 5   3    3                           0     1      0     0       0      0
## 6   3.25 3                           0     1      0     0       0      0
## # … with 965 more variables: blackberry &lt;dbl&gt;, full body &lt;dbl&gt;, chewy &lt;dbl&gt;,
## #   off &lt;dbl&gt;, rubbery &lt;dbl&gt;, earthy &lt;dbl&gt;, moss &lt;dbl&gt;, nutty &lt;dbl&gt;,
## #   chalky &lt;dbl&gt;, mildly bitter &lt;dbl&gt;, basic cocoa &lt;dbl&gt;, milk brownie &lt;dbl&gt;,
## #   macadamia &lt;dbl&gt;, fruity &lt;dbl&gt;, melon &lt;dbl&gt;, roasty &lt;dbl&gt;,
## #   brief fruit note &lt;dbl&gt;, burnt rubber &lt;dbl&gt;, alkalyzed notes &lt;dbl&gt;,
## #   sticky &lt;dbl&gt;, red fruit &lt;dbl&gt;, sour &lt;dbl&gt;, smokey &lt;dbl&gt;, grass &lt;dbl&gt;,
## #   mild tobacco &lt;dbl&gt;, mild fruit &lt;dbl&gt;, strong smoke &lt;dbl&gt;, green &lt;dbl&gt;, …</code></pre>
<p>Here we prep for modelling by creating splits, resamples and the recipe.</p>
<pre class="r"><code>set.seed(163)
splits &lt;- 
  choc_characteristics %&gt;%
  initial_split(strata = rating)

train &lt;-
  training(splits)
test &lt;-
  testing(splits)

folds &lt;- 
  bootstraps(train, 25, strata = rating)

recipe &lt;- 
  recipe(rating ~ ., train)</code></pre>
<p>The same 3 models are used for each workflowset. Here is the ‘regular’ workflowset:</p>
<pre class="r"><code>svm_spec &lt;-
  svm_linear(cost = tune(),
              margin = tune()
             ) %&gt;%
  set_mode(&quot;regression&quot;) %&gt;%
  set_engine(&quot;LiblineaR&quot;)

workflows &lt;- 
  workflow_set(
    preproc = list(recipe = recipe), 
    models = list(svm = svm_spec
                  ),
    cross = TRUE)

workflows</code></pre>
<pre><code>## # A workflow set/tibble: 1 × 4
##   wflow_id   info             option    result    
##   &lt;chr&gt;      &lt;list&gt;           &lt;list&gt;    &lt;list&gt;    
## 1 recipe_svm &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;</code></pre>
<p>And here is the text-based workflow, adapted from this <a href="https://juliasilge.com/blog/chocolate-ratings/">post.</a></p>
<pre class="r"><code># text models

set.seed(194)
choco_split &lt;- 
  initial_split(chocolate, strata = rating)
choco_train &lt;- 
  training(choco_split)
choco_test &lt;- 
  testing(choco_split)

choco_folds &lt;- 
  bootstraps(choco_train, 25, strata = rating)

choco_rec &lt;-
  recipe(rating ~ most_memorable_characteristics, data = choco_train) %&gt;%
  step_tokenize(most_memorable_characteristics) %&gt;%
  step_tokenfilter(most_memorable_characteristics, max_tokens = 100) %&gt;%
  step_tfidf(most_memorable_characteristics)

text_workflows &lt;- 
  workflow_set(
    preproc = list(text_recipe = choco_rec), 
    models = list(svm = svm_spec
                  ),
    cross = TRUE)

text_workflows</code></pre>
<pre><code>## # A workflow set/tibble: 1 × 4
##   wflow_id        info             option    result    
##   &lt;chr&gt;           &lt;list&gt;           &lt;list&gt;    &lt;list&gt;    
## 1 text_recipe_svm &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;</code></pre>
<p>Here both model types are tuned and compared:</p>
<pre class="r"><code>cl &lt;- 
  makeCluster(10)

doParallel::registerDoParallel(cl)

grid_ctrl &lt;-
  control_grid(
    save_pred = TRUE,
    allow_par = TRUE,
    parallel_over = &quot;everything&quot;,
    verbose = TRUE
  )

results &lt;- 
  workflow_map(fn = &quot;tune_grid&quot;,
               object = workflows,
               seed = 155,
               verbose = TRUE,
               control = grid_ctrl,
               grid = 10, 
               resamples = folds,
               metrics = metric_set(rmse, mae)
  )

stopCluster(cl)</code></pre>
<pre class="r"><code>cl &lt;- 
  makeCluster(10)

doParallel::registerDoParallel(cl)

grid_ctrl &lt;-
  control_grid(
    save_pred = TRUE,
    allow_par = TRUE,
    parallel_over = &quot;everything&quot;,
    verbose = TRUE
  )

text_results &lt;- 
  workflow_map(fn = &quot;tune_grid&quot;,
               object = text_workflows,
               seed = 155,
               verbose = TRUE,
               control = grid_ctrl,
               grid = 10, 
               resamples = choco_folds,
               metrics = metric_set(rmse, mae)
  )</code></pre>
<p>Using a text based approach does perform better in this case! A lot more could probably be done to improve model performance, such as more pre-processing steps, including more predictors, trying various types of models, but the goal of this post was to try out some text based models and see how those models perform to more “traditional” ML models.</p>
<pre class="r"><code>results %&gt;% 
  rank_results(select_best = T) %&gt;%
  bind_rows(text_results %&gt;% rank_results(select_best = TRUE)) %&gt;%
  filter(.metric == &quot;rmse&quot;) %&gt;%
  ggplot(., aes(x = reorder(wflow_id, mean), y = mean, color = wflow_id, label = round(mean, 4))) + 
  geom_point(show.legend = FALSE) + 
  geom_text(vjust = -0.7, show.legend = FALSE) +
  geom_errorbar(aes(ymin = mean - std_err, ymax = mean + std_err), show.legend = FALSE) +
  bg_theme(base_size = 13) + 
  ghibli::scale_color_ghibli_d(&quot;PonyoMedium&quot;) + 
  coord_flip() +
  labs(x = &quot;RMSE&quot;, y = &#39;&#39;, title = &quot;Comparing Model Types&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-13-1.png" width="864" /></p>
</div>
