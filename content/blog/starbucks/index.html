---
title: "Modeling the Relationship between Whipped Cream and Calories of Starbucks Drinks"
author: Brendan Graham
date: '2021-12-21'
slug: starbucks
categories: 
  - tidy tuesday
  - tidymodels
  - data science
tags:
  - tidy tuesday
  - tidymodels
  - data science
subtitle: 
summary: 'This post looks at a [TidyTuesday](https://github.com/rfordatascience/tidytuesday) data set about the contents of various Starbucks drinks. After epxploring the data I model the effect whiped cream has on calories across variosu types of drinks.'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
draft: false
editor_options: 
  chunk_output_type: console
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>
<script src="{{< blogdown/postref >}}index_files/core-js/shim.min.js"></script>
<script src="{{< blogdown/postref >}}index_files/react/react.min.js"></script>
<script src="{{< blogdown/postref >}}index_files/react/react-dom.min.js"></script>
<script src="{{< blogdown/postref >}}index_files/reactwidget/react-tools.js"></script>
<script src="{{< blogdown/postref >}}index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="{{< blogdown/postref >}}index_files/reactable-binding/reactable.js"></script>


<div id="explore-the-data" class="section level2">
<h2>Explore the Data</h2>
<pre class="r"><code>sbucks</code></pre>
<pre><code>## # A tibble: 1,147 × 15
##    product_name             size  milk   whip serv_size_m_l calories total_fat_g
##    &lt;chr&gt;                    &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;         &lt;dbl&gt;    &lt;dbl&gt;       &lt;dbl&gt;
##  1 brewed coffee - dark ro… short none      0           236        3         0.1
##  2 brewed coffee - dark ro… tall  none      0           354        4         0.1
##  3 brewed coffee - dark ro… gran… none      0           473        5         0.1
##  4 brewed coffee - dark ro… venti none      0           591        5         0.1
##  5 brewed coffee - decaf p… short none      0           236        3         0.1
##  6 brewed coffee - decaf p… tall  none      0           354        4         0.1
##  7 brewed coffee - decaf p… gran… none      0           473        5         0.1
##  8 brewed coffee - decaf p… venti none      0           591        5         0.1
##  9 brewed coffee - medium … short none      0           236        3         0.1
## 10 brewed coffee - medium … tall  none      0           354        4         0.1
## # … with 1,137 more rows, and 8 more variables: saturated_fat_g &lt;dbl&gt;,
## #   trans_fat_g &lt;chr&gt;, cholesterol_mg &lt;dbl&gt;, sodium_mg &lt;dbl&gt;,
## #   total_carbs_g &lt;dbl&gt;, fiber_g &lt;chr&gt;, sugar_g &lt;dbl&gt;, caffeine_mg &lt;dbl&gt;</code></pre>
<pre class="r"><code>skimr::partition(skim(sbucks))</code></pre>
<p><strong>Variable type: character</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">min</th>
<th align="right">max</th>
<th align="right">empty</th>
<th align="right">n_unique</th>
<th align="right">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">product_name</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">8</td>
<td align="right">47</td>
<td align="right">0</td>
<td align="right">93</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">size</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">7</td>
<td align="right">0</td>
<td align="right">11</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">milk</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="right">7</td>
<td align="right">0</td>
<td align="right">6</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">trans_fat_g</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">7</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">fiber_g</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">12</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">whip</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.25</td>
<td align="right">0.43</td>
<td align="right">0</td>
<td align="right">0.0</td>
<td align="right">0.0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">▇▁▁▁▂</td>
</tr>
<tr class="even">
<td align="left">serv_size_m_l</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">461.34</td>
<td align="right">172.18</td>
<td align="right">0</td>
<td align="right">354.0</td>
<td align="right">473.0</td>
<td align="right">591</td>
<td align="right">887</td>
<td align="left">▁▇▆▆▁</td>
</tr>
<tr class="odd">
<td align="left">calories</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">228.39</td>
<td align="right">137.67</td>
<td align="right">0</td>
<td align="right">130.0</td>
<td align="right">220.0</td>
<td align="right">320</td>
<td align="right">640</td>
<td align="left">▆▇▆▃▁</td>
</tr>
<tr class="even">
<td align="left">total_fat_g</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">6.19</td>
<td align="right">5.97</td>
<td align="right">0</td>
<td align="right">1.0</td>
<td align="right">4.5</td>
<td align="right">10</td>
<td align="right">28</td>
<td align="left">▇▃▂▁▁</td>
</tr>
<tr class="odd">
<td align="left">saturated_fat_g</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">3.88</td>
<td align="right">4.01</td>
<td align="right">0</td>
<td align="right">0.2</td>
<td align="right">2.5</td>
<td align="right">7</td>
<td align="right">20</td>
<td align="left">▇▃▂▁▁</td>
</tr>
<tr class="even">
<td align="left">cholesterol_mg</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">15.24</td>
<td align="right">17.97</td>
<td align="right">0</td>
<td align="right">0.0</td>
<td align="right">5.0</td>
<td align="right">30</td>
<td align="right">75</td>
<td align="left">▇▂▂▁▁</td>
</tr>
<tr class="odd">
<td align="left">sodium_mg</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">139.65</td>
<td align="right">93.09</td>
<td align="right">0</td>
<td align="right">70.0</td>
<td align="right">135.0</td>
<td align="right">200</td>
<td align="right">370</td>
<td align="left">▇▇▇▃▂</td>
</tr>
<tr class="even">
<td align="left">total_carbs_g</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">37.72</td>
<td align="right">23.26</td>
<td align="right">0</td>
<td align="right">20.0</td>
<td align="right">37.0</td>
<td align="right">53</td>
<td align="right">96</td>
<td align="left">▇▇▇▅▂</td>
</tr>
<tr class="odd">
<td align="left">sugar_g</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">34.99</td>
<td align="right">22.46</td>
<td align="right">0</td>
<td align="right">18.0</td>
<td align="right">34.0</td>
<td align="right">49</td>
<td align="right">89</td>
<td align="left">▇▇▇▅▂</td>
</tr>
<tr class="even">
<td align="left">caffeine_mg</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">91.86</td>
<td align="right">78.11</td>
<td align="right">0</td>
<td align="right">30.0</td>
<td align="right">75.0</td>
<td align="right">150</td>
<td align="right">475</td>
<td align="left">▇▃▁▁▁</td>
</tr>
</tbody>
</table>
<pre class="r"><code>get_cor &lt;- 
  function(size){
    sbucks %&gt;%
      filter(size == {{size}}) %&gt;%
      na.omit() %&gt;%
      select(where(is.numeric)) %&gt;%
      corrr::correlate() %&gt;%
      corrr::shave(upper = TRUE) %&gt;%
      corrr::rplot() +
      labs(title = glue::glue(&quot;Corellation for {size} drinks&quot;)) + big_labels
  }

map(c(&quot;short&quot;, &quot;tall&quot;, &quot;grande&quot;, &quot;venti&quot;, &quot;trenta&quot;), ~get_cor(size = .x))</code></pre>
<pre><code>## [[1]]</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-1.png" width="1248" /></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-2.png" width="1248" /></p>
<pre><code>## 
## [[3]]</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-3.png" width="1248" /></p>
<pre><code>## 
## [[4]]</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-4.png" width="1248" /></p>
<pre><code>## 
## [[5]]</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-5.png" width="1248" /></p>
<p>First we need to only include products where whip is an option; after viewing plot, looks we’ll need to remove some categories.</p>
<pre class="r"><code># https://juliasilge.com/blog/beer-production/

whip_diff &lt;- 
  sbucks %&gt;%
  select(product_name, size, milk, whip, calories) %&gt;%
  group_by(product_name, size, milk) %&gt;%
  mutate(has_whip_option = max(whip)) %&gt;%
  filter(has_whip_option == 1) %&gt;%
  mutate(whip = factor(whip, levels = c(&quot;0&quot;, &quot;1&quot;)),
         size = factor(size, levels = c(&quot;short&quot;, &quot;tall&quot;, &quot;grande&quot;, &quot;venti&quot;)),
         milk = factor(milk, levels = c(&quot;nonfat&quot;, &quot;soy&quot;, &quot;coconut&quot;, &quot;2%&quot;, &quot;whole&quot;)))


whip_diff %&gt;%
  ggplot(., aes(x = whip, y = calories)) + 
  geom_jitter(alpha = .5) +
  geom_boxplot(alpha = .75) + 
  facet_grid(milk ~ size, scales = &#39;free&#39;) + 
  big_labels</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="1248" /></p>
<p>After removing drinks with no milk, we can plot the distributions of calories and inspect for any potential interaction effects. There doesn’t seem to be any interaction effects between whipped cream and milk type used</p>
<pre class="r"><code>whip_diff &lt;- 
  whip_diff %&gt;%
  filter(size %in% c(&quot;grande&quot;, &quot;short&quot;, &quot;tall&quot;, &quot;venti&quot;),
         milk != &#39;none&#39;)

boxplot_milk &lt;- 
  ggplot(whip_diff, aes(x = whip, y = calories, fill = milk)) + 
  geom_jitter(alpha = .5) +
  geom_boxplot(alpha = .75) + 
  # facet_grid(. ~ size) + 
  labs(fill = &quot;Milk Type&quot;) + 
  big_labels + 
  scale_y_continuous(breaks = seq(100, 1000, 25))  +
  theme_minimal() + 
  theme(legend.position = &quot;none&quot;)

line_milk &lt;-
  ggline(whip_diff, x = &quot;whip&quot;, y = &quot;calories&quot;, color = &quot;milk&quot;,
         add = c(&quot;mean_se&quot;)) + 
  theme_minimal()

ggpubr::ggarrange(boxplot_milk, line_milk, nrow = 1, ncol = 2)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="1248" /></p>
<p>There may be a slight interaction effect between whipped cream and drink size</p>
<pre class="r"><code>boxplot_size &lt;- 
  ggplot(whip_diff, aes(x = whip, y = calories, fill = size)) + 
  geom_jitter(alpha = .5) +
  geom_boxplot(alpha = .75) + 
  labs(fill = &quot;Milk Type&quot;) + 
  big_labels + 
  scale_y_continuous(breaks = seq(100, 1000, 25)) +
  theme_minimal() + 
  theme(legend.position = &quot;none&quot;)

line_size &lt;-
  ggline(whip_diff, x = &quot;whip&quot;, y = &quot;calories&quot;, color = &quot;size&quot;,
         add = c(&quot;mean_se&quot;)) + 
  theme_minimal()

ggpubr::ggarrange(boxplot_size, line_size, nrow = 1, ncol = 2)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-7-1.png" width="1248" /></p>
<p>There may be a slight interaction effect between drink size and milk used</p>
<pre class="r"><code>boxplot_size_milk &lt;- 
  ggplot(whip_diff, aes(x = milk, y = calories, fill = size)) + 
  geom_jitter(alpha = .5) +
  geom_boxplot(alpha = .75) + 
  labs(fill = &quot;Milk Type&quot;) + 
  big_labels + 
  scale_y_continuous(breaks = seq(100, 1000, 25)) +
  theme_minimal() + 
  theme(legend.position = &quot;none&quot;)

line_size_milk &lt;-
  ggline(whip_diff, x = &quot;milk&quot;, y = &quot;calories&quot;, color = &quot;size&quot;,
         add = c(&quot;mean_se&quot;)) + 
  theme_minimal()

ggpubr::ggarrange(boxplot_size_milk, line_size_milk, nrow = 1, ncol = 2)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-8-1.png" width="1248" /></p>
</div>
<div id="simple-model" class="section level2">
<h2>Simple model</h2>
<p>The next step is to model the relationship between calories and the inclusion of whip cream on various drinks, while accounting for size and milk type. The LM model contains all categorical predictors and is equivalent to a 1 way ANOVA. IN this case we don’t really need to do an ANOVA beause the means are obviously different from one another. The assumptions of homogeneous variance among groups and approximately normally distributed data seem to pass given an inspection of the boxplots above.</p>
<p><span class="math display">\[
\hat{Y}= b_0 + b_1X_1 + b_2X_2 + b_3X_3 + b_4X_1X_2
\]</span></p>
<p>where:</p>
<ul>
<li>Y is calories</li>
<li>X1 is an indicator for whip cream included (ref level = 0)</li>
<li>X2 is an indicator for size of drink (4 levels, ref level = short)</li>
<li>X3 is an indicator for milk type (5 levels, ref level = nonfat)</li>
</ul>
<p>An interaction term is added since the amount of whipped cream added may vary according to the drink size; maybe <em>Venti</em> drinks get more whipped cream added than a <em>Short</em> drink and if so the impact on calories is not consistent for whipped cream drinks as size changes.</p>
<pre class="r"><code>broom::tidy(lm(calories ~ whip + size + milk + whip*size, data = whip_diff)) %&gt;%
  addtable()</code></pre>
<div id="htmlwidget-1" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"term":["(Intercept)","whip1","sizetall","sizegrande","sizeventi","milksoy","milkcoconut","milk2%","milkwhole","whip1:sizetall","whip1:sizegrande","whip1:sizeventi"],"estimate":[138.84,54.09,50.84,124.86,220.51,9.29,1.43,30.71,51.25,22.78,50.38,50.38],"std.error":[11.74,15.49,12.33,12.3,12.3,7.04,6.86,6.86,6.86,17.42,17.37,17.37],"statistic":[11.83,3.49,4.12,10.15,17.93,1.32,0.21,4.48,7.47,1.31,2.9,2.9],"p.value":[0,0,0,0,0,0.19,0.84,0,0,0.19,0,0]},"columns":[{"accessor":"term","name":"term","type":"character"},{"accessor":"estimate","name":"estimate","type":"numeric"},{"accessor":"std.error","name":"std.error","type":"numeric"},{"accessor":"statistic","name":"statistic","type":"numeric"},{"accessor":"p.value","name":"p.value","type":"numeric"}],"resizable":true,"filterable":true,"defaultPageSize":15,"paginationType":"numbers","showPageInfo":true,"minRows":1,"defaultExpanded":true,"highlight":true,"striped":true,"compact":true,"inline":true,"dataKey":"559549227df2e6fff5e0d092a94e24e0","key":"559549227df2e6fff5e0d092a94e24e0"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
<p>The intercept term alone indicates the average calories for “short” drinks with nonfat milk and without whipped cream is about 139 calories. To get the avg calories for a venti with whipped cream and whole milk, for example, we can add:</p>
<p>138.84 + 54 + 220.51 + 51.25 + 50.38 = 514.98 calories</p>
<pre class="r"><code>broom::tidy(lm(calories ~ whip + size + milk + whip*size, data = whip_diff)) %&gt;%
  filter(term != &quot;(Intercept)&quot;) %&gt;% 
  ggplot(., aes(x = reorder(term, estimate), y = estimate, label = round(estimate, 2))) + 
  geom_point() + 
  geom_text(nudge_x = .28) + 
  coord_flip() + 
  geom_hline(yintercept = 0) + 
  geom_errorbar(aes(x = term, ymin = estimate - std.error, ymax = estimate + std.error)) +
  labs(x = &quot;estimate&quot;, y = &quot;&quot;,
       title = &quot;Effect sizes relative to baseline&quot;, subtitle = &quot;baseline: short, nonfat milk without whipped cream&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-10-1.png" width="1248" /></p>
<div id="bootstrap-resampling" class="section level3">
<h3>Bootstrap Resampling</h3>
<p>There is not a ton of data here, maybe creating some bootstrap resamples might help to model this relationship. Bootstrapping creates <em>N</em> datasets by resampling <em>with replacement</em>. All of the resamples have the same number of rows as the input dataset, and contain duplicate observations since we sampled with replacement. The assessment data are comprised of the observations that didn’t make it into a given resample.</p>
<p>Below are the first 10 resamples of the dataset; each contains 550 observations to fit the model (the <em>analysis</em> split). the remaining observations are the <em>assessment</em> split, but are not used in this case, since we are not doing any model tuning or measuring any performance metrics. The model coefficients will be an average across all 5000 resamples.</p>
<pre class="r"><code># use bootstrap resampling; account for potential interaction effect
set.seed(1459)
samples &lt;-
  rsample::bootstraps(whip_diff,
                      times = 5000,
                      apparent = TRUE)

head(samples, 10)</code></pre>
<pre><code>## # A tibble: 10 × 2
##    splits            id           
##    &lt;list&gt;            &lt;chr&gt;        
##  1 &lt;split [550/200]&gt; Bootstrap0001
##  2 &lt;split [550/205]&gt; Bootstrap0002
##  3 &lt;split [550/194]&gt; Bootstrap0003
##  4 &lt;split [550/204]&gt; Bootstrap0004
##  5 &lt;split [550/198]&gt; Bootstrap0005
##  6 &lt;split [550/209]&gt; Bootstrap0006
##  7 &lt;split [550/209]&gt; Bootstrap0007
##  8 &lt;split [550/216]&gt; Bootstrap0008
##  9 &lt;split [550/199]&gt; Bootstrap0009
## 10 &lt;split [550/196]&gt; Bootstrap0010</code></pre>
<pre class="r"><code>whip_models &lt;- 
  samples %&gt;%
  mutate(
    model = map(splits, ~ lm(calories ~ whip + size + milk + whip*size, data = .)),
    coef_info = map(model, tidy)
  )</code></pre>
<p>Based on the plots, the estimates are about the same as the <code>lm</code> above!</p>
<pre class="r"><code>whip_coefs &lt;- 
  whip_models %&gt;%
  unnest(coef_info)

means &lt;- 
  whip_coefs %&gt;%
  group_by(term) %&gt;%
  summarise(est_mean = mean(estimate))

spreads &lt;- 
  int_pctl(whip_models, coef_info)

whip_coefs %&gt;%
  left_join(., means, &quot;term&quot;)  %&gt;%
  left_join(., spreads %&gt;% select(.lower, .upper, term), &quot;term&quot;)  %&gt;%
  mutate(term_label = paste(term, round(est_mean, 2))) %&gt;% 
  ggplot(aes(x = estimate, label = est_mean)) +
  geom_histogram(alpha = 0.7) + 
  facet_wrap(.~term_label, scales = &quot;free&quot;) + 
  geom_vline(aes(xintercept = est_mean))+ 
  geom_vline(aes(xintercept = .lower), linetype = &quot;dashed&quot;) + 
  geom_vline(aes(xintercept = .upper), linetype = &quot;dashed&quot;) </code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-13-1.png" width="1248" /></p>
</div>
</div>
<div id="conclusion" class="section level2">
<h2>Conclusion</h2>
<p>These 2 methods are similar ways to accomplish the same goal, and in this case we got similar result. In fact, a simple faceted boxplot could have saved a ton of time and shown us the same results - calories differ across whipped cream options, milk options and size options!</p>
<pre class="r"><code>ggplot(whip_diff, aes(x = whip, y = calories, fill = milk)) + 
  geom_jitter(alpha = .5) +
  geom_boxplot(alpha = .75) + 
  labs(fill = &quot;Milk Type&quot;) + 
  big_labels + 
  facet_grid(.~size) + 
  scale_y_continuous(breaks = seq(100, 1000, 25)) + 
  bg_theme() + 
  ggsci::scale_fill_npg()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-14-1.png" width="1248" /></p>
</div>
