---
title: "Wimbledon analysis part 1: get the data"
weight: 1
author: Brendan Graham
date: '2022-02-02'
slug: tennis-part1
categories: 
  - tennis
  - R
tags:
  - tennis
  - R
subtitle: 
summary: 'This post is the first in a series on analyzing Wimbledon tournament data.'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
draft: false
editor_options: 
  chunk_output_type: console
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>This is the first in a series of posts analyzing data from recent Wimbledon tournaments. In this post I will talk through how I retrieve and format the data. the point by point and match data come from this <a href="https://github.com/JeffSackmann/tennis_slam_pointbypoint/">amazing repo</a> that has point by point data for Wimbledon and many more tournaments.</p>
</div>
<div id="get-the-data" class="section level2">
<h2>Get the data</h2>
<p>I want to use several years worth of data. Rather than load the match data and the point by point data manually, the <code>get_url()</code> and <code>get_data()</code> functions below streamline the process.</p>
<pre class="r"><code># no tournament in 2020
years &lt;-
  c(seq(2015, 2019, 1), 2021)

get_url &lt;- 
  function(year, type){
    
    if(!type %in% c(&#39;points&#39;, &#39;matches&#39;)) stop(&quot;Type must be one of &#39;points&#39; or &#39;maches&#39;&quot;)
    
    glue(&#39;https://raw.githubusercontent.com/JeffSackmann/tennis_slam_pointbypoint/master/{year}-wimbledon-{type}.csv&#39;)
    
  }

get_data &lt;- 
  function(url){
    
    #points datasets needs an extra step in order to use map_dfr
    data &lt;- 
      if (str_detect(url, &quot;points&quot;)){
        read_csv({{url}}) %&gt;%
          as_tibble() %&gt;%
          # this step needed for map_dfr(); in some datasets point number is numeric, others its a character
          mutate(PointNumber = as.numeric(PointNumber)) %&gt;%
          clean_names()
        
      } else {
        
        readr::read_csv({{url}}) %&gt;%
          as_tibble() %&gt;%
          janitor::clean_names()
      }
    
    data
    
  }</code></pre>
<p>Here I map my 2 functions over the years list and retrieve the points and matches data from 2015-2021</p>
<pre class="r"><code>points &lt;-
  map(years, ~get_url(.x, type = &#39;points&#39;)) %&gt;%
  map_dfr(., ~get_data(.x)) 

points</code></pre>
<pre><code>## # A tibble: 265,127 × 65
##    match_id       elapsed_time set_no p1games_won p2games_won set_winner game_no
##    &lt;chr&gt;          &lt;time&gt;        &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;
##  1 2015-wimbledo… 00&#39;00&quot;            1           0           0          0       1
##  2 2015-wimbledo… 00&#39;00&quot;            1           0           0          0       1
##  3 2015-wimbledo… 00&#39;18&quot;            1           0           0          0       1
##  4 2015-wimbledo… 00&#39;40&quot;            1           0           0          0       1
##  5 2015-wimbledo… 01&#39;28&quot;            1           0           0          0       1
##  6 2015-wimbledo… 02&#39;22&quot;            1           0           0          0       1
##  7 2015-wimbledo… 02&#39;46&quot;            1           1           0          0       1
##  8 2015-wimbledo… 03&#39;40&quot;            1           1           0          0       2
##  9 2015-wimbledo… 04&#39;11&quot;            1           1           0          0       2
## 10 2015-wimbledo… 04&#39;36&quot;            1           1           0          0       2
## # … with 265,117 more rows, and 58 more variables: game_winner &lt;dbl&gt;,
## #   point_number &lt;dbl&gt;, point_winner &lt;dbl&gt;, point_server &lt;dbl&gt;,
## #   speed_kmh &lt;dbl&gt;, rally &lt;lgl&gt;, p1score &lt;chr&gt;, p2score &lt;chr&gt;,
## #   p1momentum &lt;dbl&gt;, p2momentum &lt;dbl&gt;, p1points_won &lt;dbl&gt;, p2points_won &lt;dbl&gt;,
## #   p1ace &lt;dbl&gt;, p2ace &lt;dbl&gt;, p1winner &lt;dbl&gt;, p2winner &lt;dbl&gt;,
## #   p1double_fault &lt;dbl&gt;, p2double_fault &lt;dbl&gt;, p1unf_err &lt;dbl&gt;,
## #   p2unf_err &lt;dbl&gt;, p1net_point &lt;dbl&gt;, p2net_point &lt;dbl&gt;, …</code></pre>
<pre class="r"><code>matches &lt;-
  map(years, ~get_url(.x, type = &#39;matches&#39;)) %&gt;%
  map_dfr(., ~get_data(.x)) 

matches</code></pre>
<pre><code>## # A tibble: 1,393 × 16
##    match_id  year slam  match_num player1 player2 status winner event_name round
##    &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;lgl&gt;  &lt;lgl&gt;  &lt;lgl&gt;      &lt;lgl&gt;
##  1 2015-wi…  2015 wimb…      1101 Novak … Philip… NA     NA     NA         NA   
##  2 2015-wi…  2015 wimb…      1102 Jarkko… Lleyto… NA     NA     NA         NA   
##  3 2015-wi…  2015 wimb…      1103 Pierre… Hyeon … NA     NA     NA         NA   
##  4 2015-wi…  2015 wimb…      1104 Jan Le… Bernar… NA     NA     NA         NA   
##  5 2015-wi…  2015 wimb…      1105 Leonar… Thanas… NA     NA     NA         NA   
##  6 2015-wi…  2015 wimb…      1106 Janko … Marcel… NA     NA     NA         NA   
##  7 2015-wi…  2015 wimb…      1107 Marsel… Jerzy … NA     NA     NA         NA   
##  8 2015-wi…  2015 wimb…      1108 Lucas … Kevin … NA     NA     NA         NA   
##  9 2015-wi…  2015 wimb…      1109 Marin … Hiroki… NA     NA     NA         NA   
## 10 2015-wi…  2015 wimb…      1110 Andrea… Ricard… NA     NA     NA         NA   
## # … with 1,383 more rows, and 6 more variables: court_name &lt;lgl&gt;,
## #   court_id &lt;lgl&gt;, player1id &lt;lgl&gt;, player2id &lt;lgl&gt;, nation1 &lt;lgl&gt;,
## #   nation2 &lt;lgl&gt;</code></pre>
<p>At this point I would normally save the data to a <code>data/raw</code> directory to preserve its initial state. Then I would create a separate script to read in the raw data to clean and format it. I skip that step here but below is the the code I would use to do that.</p>
<pre class="r"><code>write_feather(points, here(&quot;wimbledon&quot;, &quot;data&quot;, &quot;raw&quot;, &quot;points.feather&quot;))
write_feather(matches, here(&quot;wimbledon&quot;, &quot;data&quot;, &quot;raw&quot; &quot;matches.feather&quot;))</code></pre>
</div>
<div id="clean-the-data" class="section level2">
<h2>Clean the data</h2>
<p>The next step is to clean and prep the data for analysis.</p>
<div id="match-data" class="section level3">
<h3>Match data</h3>
<p>The matches dataset has a ton of missing data, so we can ignore most columns. Also, we cab deconstruct <code>match_num</code> to extract meaningful match metadata. For example, the first number seems to indicate a mens match (1) vs a womens match (2), the 2nd number is the round in which the match took place and the last 2 numbers are the match number. The <code>format_matches</code> function applies these steps</p>
<pre class="r"><code>matches</code></pre>
<pre><code>## # A tibble: 1,393 × 16
##    match_id  year slam  match_num player1 player2 status winner event_name round
##    &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;lgl&gt;  &lt;lgl&gt;  &lt;lgl&gt;      &lt;lgl&gt;
##  1 2015-wi…  2015 wimb…      1101 Novak … Philip… NA     NA     NA         NA   
##  2 2015-wi…  2015 wimb…      1102 Jarkko… Lleyto… NA     NA     NA         NA   
##  3 2015-wi…  2015 wimb…      1103 Pierre… Hyeon … NA     NA     NA         NA   
##  4 2015-wi…  2015 wimb…      1104 Jan Le… Bernar… NA     NA     NA         NA   
##  5 2015-wi…  2015 wimb…      1105 Leonar… Thanas… NA     NA     NA         NA   
##  6 2015-wi…  2015 wimb…      1106 Janko … Marcel… NA     NA     NA         NA   
##  7 2015-wi…  2015 wimb…      1107 Marsel… Jerzy … NA     NA     NA         NA   
##  8 2015-wi…  2015 wimb…      1108 Lucas … Kevin … NA     NA     NA         NA   
##  9 2015-wi…  2015 wimb…      1109 Marin … Hiroki… NA     NA     NA         NA   
## 10 2015-wi…  2015 wimb…      1110 Andrea… Ricard… NA     NA     NA         NA   
## # … with 1,383 more rows, and 6 more variables: court_name &lt;lgl&gt;,
## #   court_id &lt;lgl&gt;, player1id &lt;lgl&gt;, player2id &lt;lgl&gt;, nation1 &lt;lgl&gt;,
## #   nation2 &lt;lgl&gt;</code></pre>
<pre class="r"><code>format_matches &lt;- 
  function(){
    matches %&gt;%
      select(match_id:player2) %&gt;%
      mutate(category = ifelse(str_sub(match_num, 1, 1) == 1, &quot;men&quot;, &quot;women&quot;),
             round = str_sub(match_num, 2, 2),
             match_no = as.numeric(str_sub(match_num, 3, 4)))
  }

format_matches()</code></pre>
<pre><code>## # A tibble: 1,393 × 9
##    match_id    year slam   match_num player1   player2   category round match_no
##    &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;
##  1 2015-wimb…  2015 wimbl…      1101 Novak Dj… Philipp … men      1            1
##  2 2015-wimb…  2015 wimbl…      1102 Jarkko N… Lleyton … men      1            2
##  3 2015-wimb…  2015 wimbl…      1103 Pierre H… Hyeon Ch… men      1            3
##  4 2015-wimb…  2015 wimbl…      1104 Jan Lenn… Bernard … men      1            4
##  5 2015-wimb…  2015 wimbl…      1105 Leonardo… Thanasi … men      1            5
##  6 2015-wimb…  2015 wimbl…      1106 Janko Ti… Marcel G… men      1            6
##  7 2015-wimb…  2015 wimbl…      1107 Marsel I… Jerzy Ja… men      1            7
##  8 2015-wimb…  2015 wimbl…      1108 Lucas Po… Kevin An… men      1            8
##  9 2015-wimb…  2015 wimbl…      1109 Marin Ci… Hiroki M… men      1            9
## 10 2015-wimb…  2015 wimbl…      1110 Andreas … Ricardas… men      1           10
## # … with 1,383 more rows</code></pre>
<p>It’ll probably be useful to have a column for match winner. To get the winner for each match we can turn to the points data and use <code>p1games_won</code> and <code>p2games_won</code> to determine the match winner.</p>
<pre class="r"><code>get_match_winner &lt;- 
  function(){
    
    points %&gt;%
      filter(set_winner &gt; 0) %&gt;%
      select(match_id, p1games_won, p2games_won) %&gt;%
      group_by(match_id) %&gt;%
      summarise(tot_p1games_won = sum(p1games_won),
                tot_p2games_won = sum(p2games_won)) %&gt;%
      mutate(match_winner = ifelse(tot_p1games_won &gt; tot_p2games_won, &quot;player1&quot;, &quot;player2&quot;)) %&gt;%
      select(match_id, match_winner)
  }

get_match_winner()</code></pre>
<pre><code>## # A tibble: 1,387 × 2
##    match_id            match_winner
##    &lt;chr&gt;               &lt;chr&gt;       
##  1 2015-wimbledon-1101 player1     
##  2 2015-wimbledon-1102 player1     
##  3 2015-wimbledon-1103 player1     
##  4 2015-wimbledon-1104 player2     
##  5 2015-wimbledon-1105 player1     
##  6 2015-wimbledon-1106 player2     
##  7 2015-wimbledon-1107 player1     
##  8 2015-wimbledon-1108 player2     
##  9 2015-wimbledon-1109 player1     
## 10 2015-wimbledon-1110 player2     
## # … with 1,377 more rows</code></pre>
<p>Finally we can apply and join the the 2 functions to get our cleaned matches dataset. (As above, for the purposes of this post we’ll skip the step of saving the cleaned data, but the code to do so is included below).</p>
<pre class="r"><code>matches &lt;- 
  format_matches() %&gt;%
  inner_join(., get_match_winner()) %&gt;%
  mutate(match_winner = ifelse(match_winner == &quot;player1&quot;, player1, player2))

matches</code></pre>
<pre><code>## # A tibble: 1,387 × 10
##    match_id    year slam   match_num player1   player2   category round match_no
##    &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;
##  1 2015-wimb…  2015 wimbl…      1101 Novak Dj… Philipp … men      1            1
##  2 2015-wimb…  2015 wimbl…      1102 Jarkko N… Lleyton … men      1            2
##  3 2015-wimb…  2015 wimbl…      1103 Pierre H… Hyeon Ch… men      1            3
##  4 2015-wimb…  2015 wimbl…      1104 Jan Lenn… Bernard … men      1            4
##  5 2015-wimb…  2015 wimbl…      1105 Leonardo… Thanasi … men      1            5
##  6 2015-wimb…  2015 wimbl…      1106 Janko Ti… Marcel G… men      1            6
##  7 2015-wimb…  2015 wimbl…      1107 Marsel I… Jerzy Ja… men      1            7
##  8 2015-wimb…  2015 wimbl…      1108 Lucas Po… Kevin An… men      1            8
##  9 2015-wimb…  2015 wimbl…      1109 Marin Ci… Hiroki M… men      1            9
## 10 2015-wimb…  2015 wimbl…      1110 Andreas … Ricardas… men      1           10
## # … with 1,377 more rows, and 1 more variable: match_winner &lt;chr&gt;</code></pre>
<pre class="r"><code># write_feather(matches, here(&quot;wimbledon&quot;, &quot;data&quot;, &quot;formatted&quot;, &quot;matches.feather&quot;))</code></pre>
</div>
<div id="points-data" class="section level3">
<h3>Points data</h3>
<pre class="r"><code>points</code></pre>
<pre><code>## # A tibble: 265,127 × 65
##    match_id       elapsed_time set_no p1games_won p2games_won set_winner game_no
##    &lt;chr&gt;          &lt;time&gt;        &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;
##  1 2015-wimbledo… 00&#39;00&quot;            1           0           0          0       1
##  2 2015-wimbledo… 00&#39;00&quot;            1           0           0          0       1
##  3 2015-wimbledo… 00&#39;18&quot;            1           0           0          0       1
##  4 2015-wimbledo… 00&#39;40&quot;            1           0           0          0       1
##  5 2015-wimbledo… 01&#39;28&quot;            1           0           0          0       1
##  6 2015-wimbledo… 02&#39;22&quot;            1           0           0          0       1
##  7 2015-wimbledo… 02&#39;46&quot;            1           1           0          0       1
##  8 2015-wimbledo… 03&#39;40&quot;            1           1           0          0       2
##  9 2015-wimbledo… 04&#39;11&quot;            1           1           0          0       2
## 10 2015-wimbledo… 04&#39;36&quot;            1           1           0          0       2
## # … with 265,117 more rows, and 58 more variables: game_winner &lt;dbl&gt;,
## #   point_number &lt;dbl&gt;, point_winner &lt;dbl&gt;, point_server &lt;dbl&gt;,
## #   speed_kmh &lt;dbl&gt;, rally &lt;lgl&gt;, p1score &lt;chr&gt;, p2score &lt;chr&gt;,
## #   p1momentum &lt;dbl&gt;, p2momentum &lt;dbl&gt;, p1points_won &lt;dbl&gt;, p2points_won &lt;dbl&gt;,
## #   p1ace &lt;dbl&gt;, p2ace &lt;dbl&gt;, p1winner &lt;dbl&gt;, p2winner &lt;dbl&gt;,
## #   p1double_fault &lt;dbl&gt;, p2double_fault &lt;dbl&gt;, p1unf_err &lt;dbl&gt;,
## #   p2unf_err &lt;dbl&gt;, p1net_point &lt;dbl&gt;, p2net_point &lt;dbl&gt;, …</code></pre>
<p>The first part of <code>format_points()</code> creates some time columns: match minutes, set minutes and game minutes. then I add some sequence numbers that assigns a row number for each game, set and match. This comes in handy when trying to determine how many points happen in each game, set or match, and also helps to partition sets and games within a match, <code>game_seq</code> will reset after every game, <code>set_seq</code> rests after each set and <code>match_seq</code> is a sequence of row number from 1 to the end of the match.</p>
<pre class="r"><code>format_points &lt;- 
  function(){

    time &lt;- 
      points %&gt;%
      filter(point_number &gt; 0) %&gt;%
      select(match_id, set_no, elapsed_time) %&gt;%
      group_by(match_id, set_no) %&gt;%
      filter(elapsed_time == max(elapsed_time)) %&gt;%
      ungroup() %&gt;%
      group_by(match_id) %&gt;%
      mutate(
        set_length_mins = case_when(
          set_no == 1 ~ as.numeric(elapsed_time)/60,
          TRUE ~ (as.numeric(elapsed_time) - lag(as.numeric(elapsed_time)))/60),
        game_length_mins = sum(set_length_mins)
      )
    
    points_formatted &lt;- 
      points %&gt;%
      filter(point_number &gt; 0) %&gt;%
      group_by(match_id) %&gt;%
      mutate(match_seq = dplyr::row_number()) %&gt;%
      ungroup() %&gt;%
      group_by(match_id, set_no) %&gt;%
      mutate(set_seq = dplyr::row_number()) %&gt;%
      ungroup() %&gt;%
      group_by(match_id, set_no, game_no) %&gt;%
      mutate(game_seq = dplyr::row_number()) %&gt;%
      ungroup() %&gt;% 
      inner_join(., time %&gt;% select(-elapsed_time), by = c(&quot;match_id&quot;, &quot;set_no&quot;)) %&gt;%
      select(match_id, set_no, match_seq:game_length_mins, everything()) %&gt;%
      mutate(p1score = as.numeric(p1score),
             p2score = as.numeric(p2score))
    
    points_formatted
    
  }

points</code></pre>
<pre><code>## # A tibble: 265,127 × 65
##    match_id       elapsed_time set_no p1games_won p2games_won set_winner game_no
##    &lt;chr&gt;          &lt;time&gt;        &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;
##  1 2015-wimbledo… 00&#39;00&quot;            1           0           0          0       1
##  2 2015-wimbledo… 00&#39;00&quot;            1           0           0          0       1
##  3 2015-wimbledo… 00&#39;18&quot;            1           0           0          0       1
##  4 2015-wimbledo… 00&#39;40&quot;            1           0           0          0       1
##  5 2015-wimbledo… 01&#39;28&quot;            1           0           0          0       1
##  6 2015-wimbledo… 02&#39;22&quot;            1           0           0          0       1
##  7 2015-wimbledo… 02&#39;46&quot;            1           1           0          0       1
##  8 2015-wimbledo… 03&#39;40&quot;            1           1           0          0       2
##  9 2015-wimbledo… 04&#39;11&quot;            1           1           0          0       2
## 10 2015-wimbledo… 04&#39;36&quot;            1           1           0          0       2
## # … with 265,117 more rows, and 58 more variables: game_winner &lt;dbl&gt;,
## #   point_number &lt;dbl&gt;, point_winner &lt;dbl&gt;, point_server &lt;dbl&gt;,
## #   speed_kmh &lt;dbl&gt;, rally &lt;lgl&gt;, p1score &lt;chr&gt;, p2score &lt;chr&gt;,
## #   p1momentum &lt;dbl&gt;, p2momentum &lt;dbl&gt;, p1points_won &lt;dbl&gt;, p2points_won &lt;dbl&gt;,
## #   p1ace &lt;dbl&gt;, p2ace &lt;dbl&gt;, p1winner &lt;dbl&gt;, p2winner &lt;dbl&gt;,
## #   p1double_fault &lt;dbl&gt;, p2double_fault &lt;dbl&gt;, p1unf_err &lt;dbl&gt;,
## #   p2unf_err &lt;dbl&gt;, p1net_point &lt;dbl&gt;, p2net_point &lt;dbl&gt;, …</code></pre>
<pre class="r"><code># write_feather(points, here(&quot;wimbledon&quot;, &quot;data&quot;, &quot;formatted&quot;, &quot;points.feather&quot;))</code></pre>
</div>
</div>
